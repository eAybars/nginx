# Nginx with SSL
## Who needs this?
This image may be useful to anyone who wishes to serve content through SSL. It takes away the burden of retrieving and installing SSL certificate and configuring Nginx to use these certificates when serving content. 

## What does it do?
Nginx-SSL can retrieves SSL certificate(s) through **Lets Encrypt** for desired domain names, and can install and configure them on startup when it is run for the first time. It can also renew previously obtained certificates without stopping or interrupting the proxy service. 

In order to be able to serve meaningful content, the image needs to be supplied with further configuration files or content. This can either be done by mounting some configuration directories as described below or by extending this image and supplying the configurations that way.

## To run
To simply run the image without any ssl configuration:
```
docker run -d -p 80:80 -p 443:443 eaybars/nginx-ssl
```

In order to be able to obtain and configure SSL certificates, containers needs to be started on the owned domain with port 80 mapped to the image's port 80. 

You also need to supply the domain name(s) information on which you wish to serve contents and optionally a contact email to use when registering your certificate to Lets Encrypt. Although it is optional, it is strongly recommended to supply a contact mail so that you can manage your certificates and get information about them from Lets Encrypt.

You can simply provide domain names through `DOMAIN_NAMES` environment variable which can contain a single domain name or multiple domain names separated by space
```
docker run -d -p 80:80 -p 443:443 --name nginx-ssl -e DOMAIN_NAMES=mydomain.com eaybars/nginx-ssl
```
or
```
docker run -d -p 80:80 -p 443:443 --name nginx-ssl -e DOMAIN_NAMES="mydomain.com www.mydomain.com" eaybars/nginx-ssl
```
You can also simply provide a contact email information through CONTACT_EMAIL environment variable like so:

```
docker run -d -p 80:80 -p 443:443 --name nginx-ssl -e CONTACT_EMAIL=info@mydomain.com -e DOMAIN_NAMES="mydomain.com www.mydomain.com" eaybars/nginx-ssl 
```

**To prevent the container from retrieving a new certificate on every fresh start, you could mount the `/etc/letsencrypt/` directory to a persistent storage when running:**
```
docker run -d -p 80:80 -p 443:443 --name nginx-ssl -e DOMAIN_NAMES=mydomain.com -e CONTACT_EMAIL=myemail@mydomain.com -v /my/own/certificate/dir:/etc/letsencrypt/ eaybars/nginx-ssl
```

## Important Directories
Depending on your use case, you may wish to mount the following container directories to persistent storage directories
* **/etc/letsencrypt/** Used to store and manage SSL certificates and related data generated by `certbot` from Lets Encrypt. You almost always need to mount this directory to a persistent storage
* **/usr/share/nginx/modules/\*.conf** As found in the original nginx configuration file to load dynamic modules. See /usr/share/nginx/README.dynamic 
* **/etc/nginx/conf.d/\*.conf** As found in the original nginx configuration file to load modular configuration files from the `/etc/nginx/conf.d` directory. You can add any configuration to the main http block [see nginx configuration](http://nginx.org/en/docs/beginners_guide.html) by adding configuration files to the `/etc/nginx/conf.d/` directory as usual. You can define upstream servers here as an example, or you could use the `--create-nginx-conf` option to have the image automatically generate the configuration files which contain both the http and https server blocks for the configured domains, in this directory. See *Configuration* section for more on this
* **/etc/nginx/conf.d/<yourdomain.com>/http/\*.conf** When using automatically generated configuration files, http server configuration block includes configurations in this directory, where `<yourdomain.com>` is your actual domain name. This allows you to add any entries here to further configure the server to serve your http content
* **/etc/nginx/conf.d/<yourdomain.com>/https/\*.conf** When using automatically generated configuration files, https server configuration block includes configurations in this directory, where `<yourdomain.com>` is your actual domain name. This allows you to add any entries here to further configure the server to serve your https content

You can serve your content without creating a new image by mounting any or all of the above directories to suit your needs. For example the most common use may be like:
```
docker run -d -p 80:80 -p 443:443 --name nginx-ssl -e DOMAIN_NAMES=mydomain.com -e CONTACT_EMAIL=myemail@mydomain.com -v /my/own/certificate/dir:/etc/letsencrypt/ -v /my/own/main-config/dir:/etc/nginx/conf.d/ eaybars/nginx-ssl
```

## Configuration
You can run the container with different parameters to suit your needs. Available parameters are:
* **--configure-from-env**: to add configuration options found on DOMAIN_NAMES and CONTACT_EMAIL environment variables
* **--create-nginx-conf**: to the image generate nginx configuration files for the given domains. When using this option, you also need to specifty one of the following the generation strategies: 
    * **foreach**: to generate a separate configuration files for each of the domains found in the arguments. First domain argument is marked as `default_server` for https
    * **missing**: to generate a separate configuration files for each of the domains found in the arguments for which a configuration files does not already exist
    * **single**: to generate a single configuration file for all of the domains found in the arguments. In other words, this option sets `server_name` value of the generated configuration file to all the listed domains. This option also causes `default_server` mark on the generated file
    * **none**: do not generate any file, which is essentially the same as not specifying `--create-nginx-conf` 
* **-r (--renew-all)**: to perform batch renewing of certificates which are about to expire.
* **--run**: to eventually run the nginx server after requested (if any) configurations are performed
* Any other arguments to pass to [certbot as arguments](https://certbot.eff.org/docs/using.html#certbot-command-line-options)

### Most common arguments for certbot are:
* **-d**: domain name to perform configuration. May be specified more than once for each domain name
* **-m (--email)**: to register a contact email address when retrieving a new certificate
* **-w (--webroot-path)**: to specify some other web root path from which the contents of the domain name argument values proceeding this argument are served from. Defaults to `/usr/share/nginx/html/` and may be specified more than once with succeeding domain name parameters

### Certbot customization
`certbot` is triggered if the image is run with one of the `certonly`, `renew`, `certificates`, `revoke`, `delete` or `register` commands. **Any parameter which is not mentioned in this document are assumed to be targeted at certbot and therefore is appended to the argument list for certbot.** If none of these triggering commands are specified but any of the `-d`, `--domain` or `--domains` are present, than certbort is triggered as if `certonly` argument was present. `certbot` will be invoked with `certonly` with the supplied domain names along with any other accompanying arguments as mentioned earlier. 

Default arguments for the image are `--renew-all --configure-from-env --create-nginx-conf missing --run` In other words the following two are equal:
```
docker run -d -p 80:80 -p 443:443 --name nginx-ssl -e CONTACT_EMAIL=info@mydomain.com -e DOMAIN_NAMES="mydomain.com www.mydomain.com" eaybars/nginx-ssl 
```
```
docker run -d -p 80:80 -p 443:443 --name nginx-ssl -e CONTACT_EMAIL=info@mydomain.com -e DOMAIN_NAMES="mydomain.com www.mydomain.com" eaybars/nginx-ssl --renew-all --configure-from-env --create-nginx-conf missing --run
```
